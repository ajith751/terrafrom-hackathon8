# Shared Infrastructure - Terraform CI/CD
# One infra for Patient + Appointment services (decoupled repos)

name: Terraform

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  terraform:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Terraform fmt
        run: terraform fmt -check -recursive

      - name: Create backend config
        env:
          TF_BACKEND_BUCKET: ${{ secrets.TF_BACKEND_BUCKET }}
          TF_BACKEND_KEY: ${{ secrets.TF_BACKEND_KEY }}
          TF_BACKEND_REGION: ${{ secrets.TF_BACKEND_REGION }}
          TF_BACKEND_DYNAMODB: ${{ secrets.TF_BACKEND_DYNAMODB_TABLE }}
        run: |
          if [ -z "$TF_BACKEND_BUCKET" ]; then
            echo "::error::TF_BACKEND_BUCKET secret is required. Add it in Settings > Secrets and variables > Actions"
            exit 1
          fi
          echo "bucket         = \"$TF_BACKEND_BUCKET\"" > backend.hcl
          echo "key            = \"${TF_BACKEND_KEY:-healthcare-microservices/terraform.tfstate}\"" >> backend.hcl
          echo "region         = \"${TF_BACKEND_REGION:-us-east-1}\"" >> backend.hcl
          echo "dynamodb_table = \"${TF_BACKEND_DYNAMODB:-terraform-state-lock}\"" >> backend.hcl
          echo "encrypt        = true" >> backend.hcl

      - name: Verify backend config
        run: |
          test -f backend.hcl || (echo "::error::backend.hcl was not created" && exit 1)
          echo "Backend config ready (bucket: ***)"

      - name: Terraform init
        run: terraform init -input=false -backend-config=backend.hcl

      - name: Terraform validate
        run: terraform validate

      - name: Terraform plan
        run: terraform plan -var-file=environments/dev.tfvars -no-color

      - name: Terraform apply (ECR only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: terraform apply -target=module.ecr -var-file=environments/dev.tfvars -auto-approve

      - name: Build and push Lambda images to ECR
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}
        run: |
          ECR_REGISTRY=$(aws sts get-caller-identity --query Account --output text).dkr.ecr.${AWS_REGION}.amazonaws.com
          aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${ECR_REGISTRY}
          docker build -t lambda-image ./lambda
          for repo in healthcare-microservices-patient-service healthcare-microservices-appointment-service; do
            docker tag lambda-image ${ECR_REGISTRY}/${repo}:latest
            docker push ${ECR_REGISTRY}/${repo}:latest
          done

      - name: Terraform apply
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: terraform apply -replace=aws_apigatewayv2_api.main -var-file=environments/dev.tfvars -auto-approve
